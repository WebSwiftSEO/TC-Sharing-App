<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="Tc App - Decentralized Social and Crypto Platform">
    <meta name="keywords" content="Tc App, Troanary, Crypto, Social Media, Troanary Coin">
    <title>Tc App - Troanary Connection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="manifest" href="./manifest.json">
    <style>
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #0d0d0d; color: #e0e0e0; overflow-x: hidden; }
        header { background-color: #1a1a1a; color: #fff; text-align: center; padding: 1rem; border-bottom: 2px solid #00ffcc; position: relative; }
        header h1 { animation: pulse 2s infinite alternate; font-size: 2rem; margin: 0; }
        @keyframes pulse { from { color: #00ffcc; } to { color: #ffd700; } }
        #menuBtn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: #00ffcc; font-size: 1.5rem; cursor: pointer; }
        #menu { display: none; position: absolute; top: 3.5rem; right: 1rem; background: #1a1a1a; border: 1px solid #00ffcc; border-radius: 5px; padding: 0.5rem; }
        #menu button { display: block; width: 100%; text-align: left; background: none; border: none; color: #00ffcc; padding: 0.5rem; cursor: pointer; }
        #menu button:hover { color: #ffd700; }
        main { padding: 1rem; text-align: center; }
        #feed { margin-top: 1rem; padding: 1rem; background-color: #1a1a1a; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 255, 204, 0.5); }
        #globeContainer { width: 100%; max-width: 300px; height: 300px; margin: 0 auto; }
        input[type="text"], input[type="number"] { width: 80%; max-width: 300px; padding: 0.5rem; border-radius: 5px; border: 1px solid #00ffcc; background-color: #333; color: #e0e0e0; margin: 0.5rem 0; }
        button { cursor: pointer; padding: 0.5rem 1rem; border-radius: 5px; border: none; background-color: #00ffcc; color: #0d0d0d; transition: background-color 0.3s, transform 0.2s; }
        button:hover { background-color: #ffd700; transform: scale(1.1); }
        .link-item { margin: 0.5rem 0; padding: 0.5rem; background: #222; border-radius: 5px; display: flex; flex-direction: column; align-items: flex-start; }
        .link-item a { color: #00ffcc; text-decoration: none; word-break: break-all; }
        .link-item img { max-width: 100%; max-height: 200px; margin-top: 0.5rem; border-radius: 5px; }
        .link-item button { margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.9rem; }
        #loginScreen, #mainScreen { transition: opacity 0.3s; }
        #loginScreen.hidden, #mainScreen.hidden { display: none; opacity: 0; }
        #friendsList { margin-top: 1rem; }
        .friend-item { display: flex; justify-content: space-between; padding: 0.5rem; background: #222; border-radius: 5px; margin: 0.5rem 0; }
    </style>
</head>
<body>
    <header>
        <h1>ðŸš€ Tc App</h1>
        <button id="menuBtn">â˜°</button>
        <div id="menu">
            <button onclick="showInstall()">Install</button>
            <button onclick="logout()">Logout</button>
        </div>
    </header>

    <main id="loginScreen" class="hidden">
        <h2>Login</h2>
        <input type="text" id="usernameInput" placeholder="Username">
        <button onclick="login()">Login</button>
    </main>

    <main id="mainScreen" class="hidden">
        <div id="feed">
            <div id="globeContainer"></div>
            <div id="tokenStats">Tokens: <span id="userTokens">0</span> | Active Users: <span id="activeUsers">1</span> | Cap: <span id="tokenCap">1000</span></div>
            <input type="text" id="linkInput" placeholder="Share a link to earn Troanary Coins...">
            <button onclick="submitLink()">Submit</button>
            <input type="text" id="giftUser" placeholder="Username to gift tokens">
            <input type="number" id="giftAmount" placeholder="Amount">
            <button onclick="giftTokens()">Gift Tokens</button>
            <button onclick="giftTokensBluetooth()">Gift via Bluetooth</button>
            <input type="text" id="friendInput" placeholder="Add friend by username">
            <button onclick="addFriend()">Add Friend</button>
            <div id="linksContainer"></div>
            <div id="friendsList"></div>
        </div>
    </main>

    <script>
        let currentUser = null;
        let users = [];
        let links = [];
        let tokenCap = 1000;

        // PWA Setup
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(reg => console.log('Service worker registered.', reg))
                .catch(err => console.error('Service worker failed:', err));
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        // Menu Toggle
        document.getElementById('menuBtn').addEventListener('click', () => {
            const menu = document.getElementById('menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        });

        // Login
        function login() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) return alert('Enter a username!');
            currentUser = users.find(u => u.name === username);
            if (!currentUser) {
                currentUser = { name: username, tokens: 0, active: true, friends: [] };
                users.push(currentUser);
            }
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            updateTokenStats();
            displayPersonalizedFeed();
            displayFriends();
        }

        // Logout
        function logout() {
            currentUser = null;
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('menu').style.display = 'none';
        }

        // Show Install Prompt
        function showInstall() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choice => {
                    if (choice.outcome === 'accepted') console.log('PWA installed');
                    deferredPrompt = null;
                });
            }
        }

        // Submit Link with Troanary Coin Reward
        async function submitLink() {
            const linkInput = document.getElementById('linkInput').value.trim();
            if (!linkInput) return alert('Enter a link!');
            
            // Spin globe and calculate random reward based on "link quality"
            spinGlobe();
            const reward = await calculateLinkReward(linkInput);
            currentUser.tokens += reward;
            
            // Fetch link metadata for featured image
            const metadata = await fetchLinkMetadata(linkInput);
            links.push({ url: linkInput, shares: 0, owner: currentUser.name, image: metadata.image });
            updateTokenStats();
            displayPersonalizedFeed();
            document.getElementById('linkInput').value = '';
            adjustTokenCap();
        }

        // Calculate random reward based on link "quality"
        async function calculateLinkReward(url) {
            // Simple quality heuristic: length of URL + random factor
            const baseReward = Math.min(10, Math.floor(url.length / 10));
            const randomBonus = Math.floor(Math.random() * 5);
            return baseReward + randomBonus;
        }

        // Fetch link metadata (simplified for demo)
        async function fetchLinkMetadata(url) {
            // In a real app, this would use an API to fetch Open Graph data
            return { image: url.includes('image') ? 'https://via.placeholder.com/150' : null };
        }

        // Gift Tokens (online)
        function giftTokens() {
            const recipientName = document.getElementById('giftUser').value.trim();
            const amount = parseInt(document.getElementById('giftAmount').value);
            if (!recipientName || !amount || amount <= 0) return alert('Enter valid username and amount!');
            if (currentUser.tokens < amount) return alert('Not enough tokens!');
            let recipient = users.find(u => u.name === recipientName);
            if (!recipient) {
                recipient = { name: recipientName, tokens: 0, active: true, friends: [] };
                users.push(recipient);
            }
            currentUser.tokens -= amount;
            recipient.tokens += amount;
            updateTokenStats();
            document.getElementById('giftUser').value = '';
            document.getElementById('giftAmount').value = '';
            adjustTokenCap();
        }

        // Gift Tokens via Bluetooth (placeholder)
        function giftTokensBluetooth() {
            const recipientName = document.getElementById('giftUser').value.trim();
            const amount = parseInt(document.getElementById('giftAmount').value);
            if (!recipientName || !amount || amount <= 0) return alert('Enter valid username and amount!');
            if (currentUser.tokens < amount) return alert('Not enough tokens!');
            if (!navigator.bluetooth) return alert('Bluetooth not supported in this browser!');
            alert(`Simulating Bluetooth transfer of ${amount} Troanary Coins to ${recipientName}`);
            // Real Bluetooth implementation would use Web Bluetooth API
        }

        // Add Friend
        function addFriend() {
            const friendName = document.getElementById('friendInput').value.trim();
            if (!friendName || friendName === currentUser.name) return alert('Enter a valid friend username!');
            let friend = users.find(u => u.name === friendName);
            if (!friend) {
                friend = { name: friendName, tokens: 0, active: true, friends: [] };
                users.push(friend);
            }
            if (!currentUser.friends.includes(friendName)) {
                currentUser.friends.push(friendName);
                displayFriends();
            }
            document.getElementById('friendInput').value = '';
        }

        // Share Link
        function shareLink(index) {
            currentUser.tokens += 2;
            links[index].shares += 1;
            updateTokenStats();
            displayPersonalizedFeed();
        }

        // Display Personalized Feed
        function displayPersonalizedFeed() {
            const container = document.getElementById('linksContainer');
            container.innerHTML = '';
            const relevantLinks = links.filter(link => 
                link.owner === currentUser.name || 
                currentUser.friends.includes(link.owner) || 
                link.owner.includes(currentUser.name.substring(0, 3)) // Simple name-based relevance
            );
            relevantLinks.forEach((link, index) => {
                const linkElement = document.createElement('div');
                linkElement.className = 'link-item';
                linkElement.innerHTML = `
                    <a href="${link.url}" target="_blank">${link.url}</a>
                    ${link.image ? `<img src="${link.image}" alt="Featured Image">` : ''}
                    <button onclick="shareLink(${index})">Share (+2)</button>
                    <span>Shares: ${link.shares} | By: ${link.owner}</span>
                `;
                container.appendChild(linkElement);
            });
        }

        // Display Friends
        function displayFriends() {
            const container = document.getElementById('friendsList');
            container.innerHTML = '<h3>Friends</h3>';
            currentUser.friends.forEach(friendName => {
                const friend = users.find(u => u.name === friendName);
                const friendElement = document.createElement('div');
                friendElement.className = 'friend-item';
                friendElement.innerHTML = `${friendName} - ${friend.tokens} tokens`;
                container.appendChild(friendElement);
            });
        }

        // Update Token Stats
        function updateTokenStats() {
            const activeUsers = users.filter(u => u.active).length;
            document.getElementById('userTokens').textContent = currentUser ? currentUser.tokens : 0;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('tokenCap').textContent = tokenCap;
        }

        // Adjust Token Cap
        function adjustTokenCap() {
            const activeUsers = users.filter(u => u.active).length;
            const activityFactor = links.length + users.reduce((sum, u) => sum + u.tokens, 0);
            tokenCap = Math.min(10000, Math.max(100, activeUsers * 100 + activityFactor * 0.1));
            updateTokenStats();
        }

        // Three.js Globe with Spin Animation
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, 300 / 300, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(300, 300);
        document.getElementById('globeContainer').appendChild(renderer.domElement);
        const geometry = new THREE.SphereGeometry(5, 32, 32);
        const material = new THREE.MeshBasicMaterial({ color: 0x00aaff, wireframe: true });
        const globe = new THREE.Mesh(geometry, material);
        scene.add(globe);
        camera.position.z = 15;

        function animate() {
            requestAnimationFrame(animate);
            globe.rotation.y += 0.01;
            renderer.render(scene, camera);
        }
        animate();

        function spinGlobe() {
            let speed = 0.1;
            const spinInterval = setInterval(() => {
                globe.rotation.y += speed;
                speed *= 0.95;
                if (speed < 0.01) clearInterval(spinInterval);
            }, 16);
        }

        // Show login screen initially
        document.getElementById('loginScreen').classList.remove('hidden');
    </script>
</body>
</html>
